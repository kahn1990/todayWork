<%- include ../modulesTools/headerLoader %>
<%- include ../modulesTools/header %>
<link rel="stylesheet" href="../lib/quill.snow.css">
<script type="text/javascript" src="../lib/quill.js"></script>
<div class="wrapper main-content" style="padding-top: 30px;background-color: #fff;">
  <div class="container-fluid ">
    <div class="prose-tree col-md-12" id="edit_space">
      <% _data.forEach(  function( _data_box ){ %>
      <table class="table" style="overflow-x: auto;">
        <caption><%= _data_box.name %></caption>
        <tbody>
        <% _data_box.children.forEach(  function( _data_box_group ){ %>
        <th>
          <table class="table dateContent">
            <caption><%= _data_box_group.name %></caption>
            <tbody class="table dateContent">
            <tr>
              <% _data_box_group.children.forEach(  function( _data_box_user, index_user ){ %>
              <% if(index_user === 0){ %>
              <td class="td_date_box" style="width:73px;">
                <table class="table">
                  <thead>
                  <tr>
                    <th>日期</th>
                  </tr>
                  </thead>
                  <tbody>
                  <% _data_box_user.children.forEach(  function( _data_box_datenote ){ %>
                  <tr style="height:150px;background: #E8E9E8;display: inline-block;width: 100%;">
                    <td><%= new Date ( Number ( _data_box_datenote.ndate ) ).format ( 'MM/dd' ) %></td>
                  </tr>
                  <% }); %>
                  </tbody>
                </table>
              </td>
              <% } %>
              <td class="td_date_user_box" style="width:300px;">
                <table class="table">
                  <thead>
                  <tr>
                    <th><%= _data_box_user.uname %></th>
                  </tr>
                  </thead>
                  <tbody>
                  <% _data_box_user.children.forEach(  function( _data_box_datenote ){ %>
                  <tr style="height:150px;display: inline-block;width: 100%;">
                    <td style="width: 100%;height: 100%;display: inline-block;"
                        id="<%= ((( new Date ()).format ( 'yyyy-MM-dd' ) === new Date ( Number
                        ( _data_box_datenote
                          .ndate ) ).format ( 'yyyy-MM-dd' )) && (_data_box_datenote
                          .uaccount === _userAccountmd5)) ? 'basic-editor' : '' %>"
                        class="td_content_box <%= ((( new Date ()).format ( 'yyyy-MM-dd' ) === new Date ( Number
                        ( _data_box_datenote
                          .ndate ) ).format ( 'yyyy-MM-dd' )) && (_data_box_datenote
                          .uaccount === _userAccountmd5)) ? 'basicBg' : '' %>" datenote-id="<%=
                      _data_box_datenote.nid %>"
                        date-time="<%= _data_box_datenote.ndate %>"
                        user-account="<%= _data_box_datenote.uaccount %>"><%- _data_box_datenote.ncontent %> </td>
                  </tr>
                  <% }); %>
                  </tbody>
                </table>
              </td>
              <% }); %>
            </tr>
            </tbody>
          </table>
        </th>
        <% }); %>
        </tbody>
      </table>
      <% }); %>
    </div>

    <script>
      Date.prototype.format = function ( fmt ) {
        var week = [ 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', '星期日', '星期一', '星期二',
          '星期三', '星期四', '星期五', '星期六' ];
        var o    = {
          "M+" : this.getMonth () + 1, //月份
          "d+" : this.getDate (), //日
          "h+" : this.getHours (), //小时
          "m+" : this.getMinutes (), //分
          "s+" : this.getSeconds (), //秒
          "q+" : Math.floor ( (this.getMonth () + 3) / 3 ), //季度
          "S"  : this.getMilliseconds (), //毫秒
          "DD" : week[ this.getDay () + 7 ]
        };
        if ( /(y+)/.test ( fmt ) ) fmt = fmt.replace ( RegExp.$1, (this.getFullYear () + "").substr ( 4 - RegExp.$1.length ) );
        for ( var k in o )
          if ( new RegExp ( "(" + k + ")" ).test ( fmt ) ) fmt = fmt.replace ( RegExp.$1, (RegExp.$1.length == 1) ? (o[ k ]) : (("00" + o[ k ]).substr ( (k == "DD") ? 2 : ("" + o[ k ]).length )) );
        return fmt;
      };
      var basicEditor = new Quill ( '#basic-editor' );
      $ ( document ).ready ( function () {
        $ ( '#ql-editor-1' ).blur ( function ( event ) {
          var _that            = $ ( this );
          var _that_node_clone = _that.html ();
          var datenote_id      = _that.parent ().attr ( 'datenote-id' );
          $.ajax ( {
            type     : "post",
            url      : "postProseById",
            data     : { datenote_id : datenote_id, datenote_content : _that_node_clone },
            dataType : "json",
            success  : function ( data ) {
              console.log ( 'yes' );
              alert ( '修改成功' );
            },
            error    : function ( XMLHttpRequest, textStatus, errorThrown ) {
              console.log ( 'textStatus' );
              alert ( '修改成功' );
            }
          } );
          event.stopPropagation ();//阻止冒泡事件，上级的单击事件不会被调用
        } );
      } );
    </script>
  </div>
</div>
<%- include ../modulesTools/footerLoader %>